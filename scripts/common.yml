actions:
  getReplicaUser:
    - env.control.GetContainerEnvVarsByGroup[sqldb]
    - setGlobals:
        REPLICA_USER: ${response.object.REPLICA_USER}
        REPLICA_PSWD: ${response.object.REPLICA_PSWD}
    - if (/response/.test("${globals.REPLICA_USER}") && /response/.test("${globals.REPLICA_PSWD}")):
        - setReplicaUser
        - setGlobals:
            DB_USER: ${settings.user}
            DB_PASS:  ${settings.password}
        - setupUser:
            user: ${globals.REPLICA_USER}
            pswd: ${globals.REPLICA_PSWD}
            id: sqldb
  
  setReplicaUser:
    - setGlobals:
        REPLICA_USER: repl-${fn.random}
        REPLICA_PSWD: ${fn.password(20)}
    - env.control.AddContainerEnvVars[sqldb]:
        vars:
          REPLICA_USER: ${globals.REPLICA_USER}
          REPLICA_PSWD: ${globals.REPLICA_PSWD}

  setupUser:
    - if (/mysql/.test("${nodes.sqldb.nodeType}")):
        cmd[${this.id}]: |-
          MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "CREATE USER '${this.user}'@'%' IDENTIFIED BY '${this.pswd}';"
          MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "GRANT USAGE, SELECT, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO '${this.user}'@'%';"
          MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "FLUSH PRIVILEGES;"

    - if (/mariadb/.test("${nodes.sqldb.nodeType}")):
      - if ('${fn.compare([nodes.sqldb.version], 10.5)}' == -1):
          cmd[${this.id}]: |-
            MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "CREATE USER '${this.user}'@'%' IDENTIFIED BY '${this.pswd}';"
            MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "GRANT USAGE, SELECT, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO '${this.user}'@'%';"
            MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "FLUSH PRIVILEGES;"
      - else:
          cmd[${this.id}]: |-
            MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "CREATE USER '${this.user}'@'%' IDENTIFIED BY '${this.pswd}';"
            MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "GRANT USAGE, SELECT, SHOW DATABASES, REPLICATION SLAVE, SLAVE MONITOR, BINLOG MONITOR ON *.* TO '${this.user}'@'%';"
            MYSQL_PWD=${globals.DB_PASS} mysql -u${globals.DB_USER} -e "FLUSH PRIVILEGES;"

  setupAdminUser:
    - cmd[${this.id}]: |-
        wget ${globals.PATH}/scripts/setupUser.sh -O ~/setupUser.sh &>> /var/log/run.log;
        bash ~/setupUser.sh ${globals.DB_USER} ${globals.DB_PASS} &>> /var/log/run.log;
      user: root

  setupUsers:
    - setupAdminUser: 
        id: ${this.id}
    - setupUser: 
        id: ${this.id}
        user: ${globals.REPLICA_USER}
        pswd: ${globals.REPLICA_PSWD}
